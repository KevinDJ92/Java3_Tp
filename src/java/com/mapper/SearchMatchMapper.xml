<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mapper.SearchMatchMapper" >
      <resultMap type="User" id="UserPreferencesResultMap">
        <id property="id_user" column="id_user"/>
        <result property="sex" column="sex"/>
        <result property="age" column="age"/>
        <association property="preference" resultMap="PreferencesMapper"/>
    </resultMap>
    <resultMap type="Preferences" id="PreferencesMapper">
        <result property="sex_preference" column="sex_preference"/>
        <result property="min_age" column="min_age"/>
        <result property="max_age" column="max_age"/>  
   </resultMap>
   
    <select id="getUserPreferences" parameterType="int" resultMap="UserPreferencesResultMap">
	SELECT * FROM users INNER JOIN preferences ON users.id_user = preferences.id_user
 	WHERE users.id_user = #{id_user} 
    </select> 
    
    <select id="getUserSex" parameterType="int" resultType="User">
        SELECT id_user, sex, age FROM users WHERE users.id_user = #{id_user} 
    </select> 
   
    <select id="getPreferredUser" parameterType="hashmap" resultType="User">
        SELECT username
        FROM users 
        <where>
             (age BETWEEN ${min_age} AND ${max_age}) AND
             users.id_user != ${id_user}
            <if test="_parameter.containsKey('sex_preference')">
              AND sex = '${sex_preference}'
            </if> 
                 AND users.id_user IN (SELECT id_user FROM preferences
                                           <where>
                                               min_age <![CDATA[ <= ]]> ${age} AND
                                               max_age <![CDATA[ >= ]]> ${age}
                                               <if test="sex_preference != 'both'">
                                                   AND sex_preference = '${sex}' 
                                               </if>
                                           </where> )           
        </where>
    </select> 
</mapper>